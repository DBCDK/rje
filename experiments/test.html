<html>
<head>
<!-- currently only jquery due to zepto issue #146, - should be simple to fix though 
<script src="zepto.js"></script>
-->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<script src="http://code.jquery.com/jquery-1.6.min.js"></script>
<script src="jsonml.js"></script>
<script src="mui.js"></script>
<link rel="stylesheet" href="mui.css" />
<!--
<script src="main.js"></script>
-->
<script>
var fib = (function() {
    a=b=i=1;

    return function fib(mui) {
        setTimeout(function() {
            do {
                mui.append(a);
                var c = a + b;
                a = b;
                b = c;
            } while(i++ & 7);
            if(i<60) {
                mui.more(fib);
            }
        }, 1000);
    }

})();
function searchresults(query) {
    var first = true;
    var start = 1;
    var step = 5;
    var hitcount;
    if(!query) {
        return function(mui) {
            mui.append("");
        }
    }
    return function resultsFn(mui) {
        mui.callJsonpWebservice('http://opensearch.addi.dk/1.0/', 'callback', 
        {
            action: 'search', 
            query: query,
            source: 'bibliotekdk', 
            start: start, 
            stepValue: step, 
            outputType: 'json'}, 
            function(data) { 
                console.log("result:", data); 
                if(first) {
                    hitcount =  +data.searchResponse.result.hitCount.$;
                    mui.append('Searching for "' + query + '" yielded ' + hitcount + ' hits');
                    first = false;
                }
                var results = data.searchResponse.result.searchResult;
                console.log("results:", results); 
                for(var i=0; i < results.length;++i) {
                    mui.append(
                        '<div class="contentbox">' + (start+i) + ": "+ JSON.stringify(results[i].collection.object.record.title)+ "<br />"+
                        JSON.stringify(results[i].collection.object.record.creator) + "</div>"

                    );
                    console.log(JSON.stringify(results[i].collection.object.record.title));
                }
                start+=step;
                if(start <= hitcount) {
                    mui.more(resultsFn);
                }
            });
    }
}
function search(mui) {
    var query = mui.formValue("query");
    mui.showPage(["page", {title: "Dynamic result"},
        ["section",
        ["section", ["input", {type: "textbox", name: "query", label: "Søgestreng"}]],
        ["button", {fn: search}, "Søg"]],
        ["section", {autocontent: searchresults(query)}]]
        );
//    mui.showPage(["div", {onclick: function() { alert("blah")}},
//        ["section", ["text", "Hello"]]]);

// r.searchResponse.error.$
// JSON.stringify(r.searchResponse.result.searchResult[0].collection.object.record)
}
mui.setMain(search);
</script>
</head>
<body>
<div id="container">
<div id="current">
</div>
<div class="contentend"></div>
</div>
<div id="loading">Loading...</div>
</body>
